name: Run MAAS Terraform modules Smoke Tests

on:
  pull_request:
    types: [labeled, synchronize]
  workflow_dispatch:
    inputs:
      pr_number:
        description: "PR number to test (for fork PRs)"
        required: true

jobs:
  run-smoke:
    runs-on: self-hosted-linux-amd64-noble-private-endpoint-medium

    # Run if:
    # 1. Manual dispatch (maintainer approved), OR
    # 2. Label "run-tests" was added AND (Internal PR OR trusted author)
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event.label.name == 'run-tests' &&
       (github.event.pull_request.head.repo.full_name == github.repository ||
        contains(fromJSON('["OWNER", "MEMBER", "COLLABORATOR"]'), github.event.pull_request.author_association)))

    steps:
      - name: Determine ref to checkout
        id: ref
        uses: actions/github-script@v7
        with:
          script: |
            if (context.eventName === 'workflow_dispatch') {
              const pr = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: ${{ inputs.pr_number || 0 }}
              });
              core.setOutput('sha', pr.data.head.sha);
              core.setOutput('pr_number', ${{ inputs.pr_number || 0 }});
            } else {
              core.setOutput('sha', context.payload.pull_request.head.sha);
              core.setOutput('pr_number', context.payload.pull_request.number);
            }

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.ref.outputs.sha }}

      - name: Prepare Testflinger attachments
        run: ./testflinger.sh
        working-directory: tests
        env:
          SMOKE_TEST: true

      - name: Run on Testflinger
        uses: canonical/testflinger/.github/actions/submit@987fd7ab1467065217a9c6496eb2c3d85a250509
        with:
          poll: true
          job-path: ./tests/testflinger.yaml
          attachments-relative-to: ./tests/

      - name: Report status
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: '${{ steps.ref.outputs.sha }}',
              state: '${{ job.status }}' === 'success' ? 'success' : 'failure',
              context: 'Smoke Tests',
              description: '${{ job.status }}' === 'success' ? 'Tests passed' : 'Tests failed',
              target_url: '${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}'
            });

  # Optional: Guide external contributors when their PR is skipped
  guide-external:
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'pull_request' &&
      github.event.pull_request.head.repo.full_name != github.repository &&
      !contains(fromJSON('["OWNER", "MEMBER", "COLLABORATOR"]'), github.event.pull_request.author_association)
    steps:
      - name: Post guidance comment
        uses: actions/github-script@v7
        with:
          script: |
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });
            const marker = '<!-- smoke-test-guidance -->';
            const hasComment = comments.data.some(c => c.body.includes(marker));
            if (!hasComment) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `${marker}\nðŸ‘‹ Thanks for your contribution! Smoke tests require maintainer approval for fork PRs.\n\nA maintainer can run the tests via **Actions â†’ Smoke Tests â†’ Run workflow** with PR number \`${context.issue.number}\`.`
              });
            }

  # Remove label when PR code changes
  remove-label-on-update:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && github.event.action == 'synchronize'
    steps:
      - name: Remove run-tests label
        uses: actions/github-script@v7
        with:
          script: |
            try {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                name: 'run-tests'
              });
              console.log('Label removed successfully');
            } catch (error) {
              if (error.status === 404) {
                console.log('Label was not present');
              } else {
                throw error;
              }
            }
